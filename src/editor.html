
<html><head><title>MapCSS editor with syntax highlighting</title>
  <link rel="stylesheet" href="leaflet/leaflet.css" />
  <link rel="stylesheet" type="text/css" href="jquery.notify.css" />
  <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.10.3/themes/black-tie/jquery-ui.css" />
  <script src="leaflet/leaflet.js"></script>
  <script src="kothic/kothic.min.js"></script>
  <script src="kothic/kothic-leaflet.js"></script> 
  <script src="styles/osmosnimki.js"></script>
  
  <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>  
  <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
  <script src="jquery.notify.js"></script>
  <script src="config.js"></script>
</head>
<body>
<table width=100% height=100%>
  <tr>
    <td rowspan="2" width=50%>
      <div id="map" style="height:100%; width:100%"></div>
    </td>
    <td height=30>
      <button id="save">Submit</button>
    </td>
    <form method="post" action="download.php" id="postfields">
		<input type="hidden"  name="format" id="format"/>
		<input type="hidden"  name="mapcss" id="mapcss"/>
	</form>
    <td height="30">
      <button id="css">Download as MapCSS</button>
    </td>
    <td height="30">
      <button id="js">Download as JS</button>
    </td>
  </tr>
  <tr>
    <td valign="top" colspan="2">
      <div id="editor" style="height: 80%; width: 50%;" >  
canvas{fill-color:white}
way[highway]{color:red; width:3}
      </div>
    </td>
  </tr>
</table>

<script src="src/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="src/mode-mapcss.js" type="text/javascript" charset="utf-8"></script>
<script>
window.onload = function() {
    editor = ace.edit("editor");
    var MapcssMode = require("ace/mode/mapcss").Mode;
		editor.getSession().setMode(new MapcssMode());
		editor.getSession().on('change', function(){changed=true;});
};
</script>


<script>
    changed = false;

    
    var map = new L.Map('map', {
			center: new L.LatLng(startY, startX), // from config.js
			zoom: startZ
		});
    var kothic = new L.TileLayer.Kothic(vtileUrl, { //vtileUrl - from config.js
            minZoom: 3,
            styles: ['osmosnimki']
    });
    map.addLayer(kothic);
    

    function updateStyle() {

        $.post('./converter.php', 
			{
				"mapcss":editor.getSession().getValue()
			},
		function(data) {
			eval(data);
			try {
				kothic.enableStyle('converted');
				kothic.disableStyle('osmosnimki');
			}
			catch(e) {
				alert('No luck today');
			}

        });
      };
      
   function downloadStyle(type) {
		  var form = $('#postfields');
		  $('#format').val(type);
		  $('#mapcss').val(editor.getSession().getValue());
		  form.submit();
		  $('#format').val('');
		  $('#mapcss').val('');
		}
    $('#save').click(
		function() {
			updateStyle();
		}
	);
    $('#css').click(
		function() {
			downloadStyle('css');
		}
	);
    $('#js').click(
		function() {
			downloadStyle('js');
		}
	);
</script>



</body>
</html>
